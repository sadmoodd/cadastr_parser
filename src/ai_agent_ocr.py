# -*- coding: utf-8 -*-
"""
ai_agent_ocr.py
---------------
AI-Ğ°Ğ³ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· PDF Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ DeepSeek-OCR Ñ‡ĞµÑ€ĞµĞ· Hugging Face.
"""

import base64
from pathlib import Path
from typing import Dict, Optional, Tuple
from pdf2image import convert_from_path
from PIL import Image
from io import BytesIO
from huggingface_hub import InferenceClient
import os

from logger_cfg import setup_logger

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

logger = setup_logger(__name__)

# Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Hugging Face
# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ¼ĞµĞ½Ğ½ÑƒÑ Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ¼
HF_TOKEN = os.getenv("HF_TOKEN")
if not HF_TOKEN:
    raise RuntimeError("HF_TOKEN env var is not set")
HF_MODEL = "Qwen/Qwen3-VL-30B-A3B-Instruct"

client = InferenceClient(token=HF_TOKEN)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ’Ğ¡ĞŸĞĞœĞĞ“ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def pdf_to_images(pdf_path: str, dpi: int = 100) -> list:
    """
    ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ PDF Ğ² Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ.
    
    Args:
        pdf_path: ĞŸÑƒÑ‚ÑŒ Ğº PDF Ñ„Ğ°Ğ¹Ğ»Ñƒ
        dpi: Ğ Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ (300 DPI Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ)
        
    Returns:
        list: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº PIL Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹
    """
    try:
        logger.debug(f"ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ PDF Ğ² Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ (DPI={dpi})...")
        images = convert_from_path(pdf_path, dpi=dpi)
        logger.debug(f"Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¾ {len(images)} Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹")
        return images
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸ PDF: {e}")
        return []


def image_to_base64(image: Image.Image, max_size=(1024, 1024), quality=75) -> str:
    """
    ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ PIL Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ² base64 ÑÑ‚Ñ€Ğ¾ĞºÑƒ.
    
    Args:
        image: PIL Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ
        
    Returns:
        str: Base64 Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
    """
    image = image.copy()
    image.thumbnail(max_size, Image.Resampling.LANCZOS)
    buffered = BytesIO()
    image.save(buffered, format='JPEG', quality=quality)
    return base64.b64encode(buffered.getvalue()).decode()



def create_deepseek_prompt(page_number: int, total_pages: int) -> str:
    """
    Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ´Ğ»Ñ DeepSeek-OCR Ñ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸ÑĞ¼Ğ¸ Ğ¿Ğ¾ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ•Ğ“Ğ Ğ.
    
    Args:
        page_number: ĞĞ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
        total_pages: Ğ’ÑĞµĞ³Ğ¾ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†
        
    Returns:
        str: ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
    """
    
    prompt = f"""Ğ¢Ñ‹ - ÑĞºÑĞ¿ĞµÑ€Ñ‚ Ğ¿Ğ¾ Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ¸Ğ· Ğ²Ñ‹Ğ¿Ğ¸ÑĞ¾Ğº Ğ•Ğ“Ğ Ğ (Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ³Ğ¾ÑÑƒĞ´Ğ°Ñ€ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ€ĞµĞµÑÑ‚Ñ€ Ğ½ĞµĞ´Ğ²Ğ¸Ğ¶Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸).

Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°: Ğ Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ¹ Ğ’Ğ¡Ğ• Ñ‚ĞµĞºÑÑ‚ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ {page_number}/{total_pages} ÑÑ‚Ğ¾Ğ¹ Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ¸ Ğ•Ğ“Ğ Ğ.

ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜ Ğ’ĞĞ–ĞĞ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¸ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ:
1. ĞšĞ°Ğ´Ğ°ÑÑ‚Ñ€Ğ¾Ğ²Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ (Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: XX:XX:XXXXXXX:XXX, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ 74:36:0303005:454)
2. ĞĞ´Ñ€ĞµÑ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ° Ğ½ĞµĞ´Ğ²Ğ¸Ğ¶Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
3. ĞŸĞ»Ğ¾Ñ‰Ğ°Ğ´ÑŒ (Ğ² Ğ¼Â²)
4. Ğ¡Ğ¾Ğ±ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¸Ğº (Ğ¤Ğ˜Ğ Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸)
5. Ğ’Ğ¸Ğ´Ñ‹ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
6. ĞšĞ°Ğ´Ğ°ÑÑ‚Ñ€Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ (Ğ² Ñ€ÑƒĞ±Ğ»ÑÑ…)
7. ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ Ğ·ĞµĞ¼ĞµĞ»ÑŒ
8. Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ± Ğ¾Ğ±Ñ€ĞµĞ¼ĞµĞ½ĞµĞ½Ğ¸ÑÑ… Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ğµ:
   - Ğ¢Ğ¸Ğ¿ Ğ¾Ğ±Ñ€ĞµĞ¼ĞµĞ½ĞµĞ½Ğ¸Ñ (Ğ°Ñ€ĞµĞ½Ğ´Ğ°, ÑĞµÑ€Ğ²Ğ¸Ñ‚ÑƒÑ‚ Ğ¸ Ñ‚.Ğ´.)
   - Ğ¡Ñ€Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ (Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ)
   - ĞÑ€ĞµĞ½Ğ´Ğ°Ñ‚Ğ¾Ñ€ (Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ»Ğ¸ Ğ¤Ğ˜Ğ)

Ğ˜ĞĞ¡Ğ¢Ğ Ğ£ĞšĞ¦Ğ˜Ğ˜ ĞŸĞ Ğ ĞĞ¡ĞŸĞĞ—ĞĞĞ’ĞĞĞ˜Ğ®:
- Ğ Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ²Ğ°Ğ¹ Ñ‚ĞµĞºÑÑ‚ ĞœĞĞšĞ¡Ğ˜ĞœĞĞ›Ğ¬ĞĞ Ğ¢ĞĞ§ĞĞ, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ñ†Ğ¸Ñ„Ñ€Ñ‹ Ğ¸ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹
- Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞ¹ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½ÑƒÑ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°
- Ğ•ÑĞ»Ğ¸ Ğ²Ğ¸Ğ´Ğ¸ÑˆÑŒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ - Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ¹ ĞµÑ‘ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾Ñ‡Ğ½Ğ¾
- ĞĞ±Ñ€Ğ°Ñ‰Ğ°Ğ¹ Ğ¾ÑĞ¾Ğ±Ğ¾Ğµ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° ĞºĞ°Ğ´Ğ°ÑÑ‚Ñ€Ğ¾Ğ²Ñ‹Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° (Ğ¾Ğ½Ğ¸ Ğ²Ğ°Ğ¶Ğ½ĞµĞµ Ğ²ÑĞµĞ³Ğ¾!)
- Ğ§Ğ¸ÑĞ»Ğ° Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ²Ğ°Ğ¹ Ğ°ĞºĞºÑƒÑ€Ğ°Ñ‚Ğ½Ğ¾ (Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ Ğ¿Ğ»Ğ¾Ñ‰Ğ°Ğ´ÑŒ Ğ¸ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ)
- Ğ”Ğ°Ñ‚Ñ‹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞ¹ ĞºĞ°Ğº Ğ”Ğ”.ĞœĞœ.Ğ“Ğ“Ğ“Ğ“

Ğ¤ĞĞ ĞœĞĞ¢ ĞĞ¢Ğ’Ğ•Ğ¢Ğ:
Ğ’ĞµÑ€Ğ½Ğ¸ Ğ²ĞµÑÑŒ Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ² Ñ‚Ğ¾Ğ¼ Ğ¶Ğµ Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞµ, ĞºĞ°Ğº Ğ¾Ğ½ Ñ€Ğ°ÑĞ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ.
ĞĞµ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ, Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° ĞºĞ°Ğ¶ĞµÑ‚ÑÑ Ğ¼Ğ°Ğ»Ğ¾Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹.

ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ğ¹ Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ²Ğ°Ğ½Ğ¸Ğµ:"""
    
    return prompt


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ“Ğ›ĞĞ’ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ AI-ĞĞ“Ğ•ĞĞ¢Ğ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def process_image_with_deepseek(image: Image.Image, page_num: int, total_pages: int) -> Optional[str]:
    try:
        logger.debug(f"ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ {page_num}/{total_pages} Ñ‡ĞµÑ€ĞµĞ· DeepSeek-OCR...")
        image_b64 = image_to_base64(image)
        prompt = create_deepseek_prompt(page_num, total_pages)

        messages = [
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": prompt},
                    {
                        "type": "image_url",
                        "image_url": {
                            "url": f"data:image/jpeg;base64,{image_b64}"
                        }
                    }
                ]
            }
        ]

        response = client.chat_completion(
            model=HF_MODEL,
            messages=messages,
            max_tokens=4096,
            temperature=0.1,
        )

        extracted_text = response.choices[0].message.content
        logger.debug(f"Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° {page_num}: Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¾ {len(extracted_text)} ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²")
        return extracted_text

    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° LLM-ĞºĞ¾Ğ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ {page_num}: {type(e).__name__}: {str(e)}")
        return None



def process_pdf_with_ai_agent(pdf_path: str) -> Tuple[bool, Optional[str]]:
    """
    Ğ“Ğ›ĞĞ’ĞĞĞ¯ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯ AI-ĞĞ“Ğ•ĞĞ¢Ğ.
    ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ PDF Ñ„Ğ°Ğ¹Ğ» Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ DeepSeek-OCR.
    
    Args:
        pdf_path: ĞŸÑƒÑ‚ÑŒ Ğº PDF Ñ„Ğ°Ğ¹Ğ»Ñƒ
        
    Returns:
        Tuple[bool, Optional[str]]: (ÑƒÑĞ¿ĞµÑ…, Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚)
    """
    
    logger.info(f"ğŸ¤– AI-Ğ°Ğ³ĞµĞ½Ñ‚ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ: {Path(pdf_path).name}")
    
    try:
        # 1. ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ PDF Ğ² Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
        images = pdf_to_images(pdf_path, dpi=100)
        
        if not images:
            logger.error("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ PDF Ğ² Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ")
            return False, None
        
        logger.info(f"ğŸ“„ PDF ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ {len(images)} ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†")
        
        # 2. ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ°Ğ¶Ğ´ÑƒÑ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ñ‡ĞµÑ€ĞµĞ· DeepSeek-OCR
        all_text = []
        
        for idx, image in enumerate(images, 1):
            logger.info(f"ğŸ” ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ {idx}/{len(images)}...")
            
            page_text = process_image_with_deepseek(image, idx, len(images))
            
            if page_text:
                all_text.append(f"=== Ğ¡Ğ¢Ğ ĞĞĞ˜Ğ¦Ğ {idx} ===\n{page_text}\n")
                logger.info(f"âœ“ Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° {idx}: {len(page_text)} ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²")
            else:
                logger.warning(f"âš ï¸ Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° {idx}: Ñ‚ĞµĞºÑÑ‚ Ğ½Ğµ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½")
        
        # 3. ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ Ğ²ĞµÑÑŒ Ñ‚ĞµĞºÑÑ‚
        if not all_text:
            logger.error("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ Ñ‚ĞµĞºÑÑ‚ Ğ½Ğ¸ Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹")
            return False, None
        
        final_text = "\n\n".join(all_text)
        
        logger.info(f"âœ… AI-Ğ°Ğ³ĞµĞ½Ñ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ» Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ: {len(final_text)} ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²")
        
        return True, final_text
        
    except Exception as e:
        logger.error(f"ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° AI-Ğ°Ğ³ĞµĞ½Ñ‚Ğ°: {type(e).__name__}: {str(e)}")
        return False, None


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ¢Ğ•Ğ¡Ğ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if __name__ == "__main__":
    print("ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ AI-Ğ°Ğ³ĞµĞ½Ñ‚Ğ° DeepSeek-OCR\n")
    
    test_pdf = "data/input/test-1.pdf"  # Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ½Ğ° Ğ²Ğ°Ñˆ PDF
    
    if Path(test_pdf).exists():
        print(f"ğŸ“„ Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ°: {test_pdf}\n")
        
        success, text = process_pdf_with_ai_agent(test_pdf)
        
        if success and text:
            print(f"âœ… Ğ£Ğ¡ĞŸĞ•Ğ¥! Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¾ {len(text)} ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²\n")
            print("ĞŸĞµÑ€Ğ²Ñ‹Ğµ 500 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²:\n")
            print(text[:500])
        else:
            print("âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ Ñ‚ĞµĞºÑÑ‚")
    else:
        print(f"âŒ Ğ¤Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½: {test_pdf}")